/*!
    *
    * Wijmo Library 5.20192.631
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{_getModule,CancelEventArgs,assert,isFunction,closest,Control,CollectionView,isString,asNumber,asBoolean,hasClass,copy,Event,EventArgs,_registerModule}from"wijmo/wijmo";import*as selfModule from"wijmo/wijmo.undo";export class UndoableAction{constructor(t){this._target=t}undo(){this.applyState(this._oldState),this._actions&&this._actions.forEach(t=>{t.undo()})}redo(){this.applyState(this._newState),this._actions&&this._actions.forEach(t=>{t.redo()})}close(){return!0}applyState(t){}shouldAddAsChildAction(t){return!1}addChildAction(t){this._actions||(this._actions=[]),this._actions.push(t)}get target(){return this._target}};export class _UndoStackHTML{static addTarget(t,e){let n=!1;if(e instanceof HTMLInputElement)_UndoStackHTML._addInputElement(t,e),n=!0;else if(e instanceof HTMLTextAreaElement)_UndoStackHTML._addTextAreaElement(t,e),n=!0;else if(e instanceof HTMLSelectElement)_UndoStackHTML._addSelectElement(t,e),n=!0;else for(let i=0;i<e.children.length;i++){let o=e.children[i];t.addTarget(o)&&(n=!0)}return n}static _addInputElement(t,e){if("checkbox"==e.type)e.addEventListener("click",e=>{t._pendingAction=new CheckboxClickAction(e),t.pushPendingAction()});else if("radio"==e.type){e.addEventListener("mousedown",e=>{t._pendingAction=new RadioClickAction(e)},!0);let n=_UndoStackHTML._getLabel(e);n&&n.addEventListener("mousedown",n=>{t._pendingAction=new RadioClickAction({target:e})},!0),e.addEventListener("focus",e=>{t._pendingAction instanceof RadioClickAction&&t._pendingAction.target==e.target||(t._pendingAction=new RadioClickAction(e))}),e.addEventListener("click",e=>{t._pendingAction instanceof RadioClickAction&&t.pushPendingAction()})}else e.addEventListener("focus",e=>{t._pendingAction=new InputChangeAction(e)}),e.addEventListener("blur",e=>{t._pendingAction instanceof InputChangeAction&&t.pushPendingAction()})}static _addTextAreaElement(t,e){e.addEventListener("focus",e=>{t._pendingAction=new InputChangeAction(e)}),e.addEventListener("blur",e=>{t._pendingAction instanceof InputChangeAction&&t.pushPendingAction()})}static _addSelectElement(t,e){e.addEventListener("focus",e=>{t._pendingAction=new InputChangeAction(e)}),e.addEventListener("blur",e=>{t._pendingAction instanceof InputChangeAction&&t.pushPendingAction()})}static _getLabel(t){let e=t.parentElement;return e instanceof HTMLLabelElement||(e=document.querySelector('label[for="'+t.id+'"')),e}};export class InputChangeAction extends UndoableAction{constructor(t){super(t.target),assert(t.target instanceof HTMLInputElement||t.target instanceof HTMLTextAreaElement||t.target instanceof HTMLSelectElement,"HTMLInputElement, HTMLTextAreaElement, or HTMLSelectElement expected."),this._oldState=this._target.value}close(){return this._newState=this._target.value,this._newState!=this._oldState}applyState(t){let e=this._target;e.value=t,e.dispatchEvent(UndoStack._evtInput),isFunction(e.select)?e.select():e.focus()}};export class CheckboxClickAction extends UndoableAction{constructor(t){super(t.target),assert("checkbox"==this._target.type,"checkbox expected"),this._newState=this._target.checked,this._oldState=!this._newState}applyState(t){this._target.checked=t,this._target.focus()}};export class RadioClickAction extends UndoableAction{constructor(t){super(t.target);let e=this._target.type;assert("radio"==e,"radio button expected"),this._oldState=this._getState()}close(){return this._newState=this._getState(),this._newState!=this._oldState}applyState(t){t&&(t.checked=!0,t.focus())}_getState(){let t='input[name="'+this._target.name+'"]',e=document.querySelectorAll(t);for(let t=0;t<e.length;t++)if(e[t].checked)return e[t];return null}};export class UndoStack{constructor(t,e){this._autoKbd=!0,this._stack=[],this._maxActions=1e3,this._ptr=0,this.addingTarget=new Event,this.addedTarget=new Event,this.addingAction=new Event,this.addedAction=new Event,this.undoingAction=new Event,this.undoneAction=new Event,this.redoingAction=new Event,this.redoneAction=new Event,this.stateChanged=new Event,UndoStack._evtInput=document.createEvent("HTMLEvents"),UndoStack._evtInput.initEvent("input",!0,!1),e&&copy(this,e),this.addTarget(t||"body"),document.addEventListener("keydown",t=>{if(this._autoKbd&&t.ctrlKey&&!t.defaultPrevented)switch(t.keyCode){case 90:this.canUndo&&(this.undo(),t.stopImmediatePropagation());break;case 89:this.canRedo&&(this.redo(),t.stopImmediatePropagation())}},!0)}addTarget(t){let e=!1;if(isString(t)){let e=document.querySelectorAll(t),n=!1;for(let t=0;t<e.length;t++)this.addTarget(e[t])&&(n=!0);return n}assert(t instanceof HTMLElement,"Undo target should be an HTML element");let n=new AddTargetEventArgs(t);if(n.cancel=hasClass(t,"wj-no-undo"),this.onAddingTarget(n)){let i=Control.getControl(t);i&&(e=_UndoStackWijmo.addTarget(this,i)),e||closest(t,".wj-control")||(e=_UndoStackHTML.addTarget(this,t)),e&&this.onAddedTarget(n)}return e}get autoKeyboard(){return this._autoKbd}set autoKeyboard(t){this._autoKbd=asBoolean(t)}get isDisabled(){return this._disabled}set isDisabled(t){this._disabled=asBoolean(t)}get maxActions(){return this._maxActions}set maxActions(t){t!=this._maxActions&&(this._maxActions=asNumber(t,!1,!0),this.clear())}get actionCount(){return this._stack.length}get canUndo(){return this._stack.length&&this._ptr>0&&!this._disabled}get canRedo(){return this._stack.length&&this._ptr<this._stack.length&&!this._disabled}undo(){if(this.canUndo){let t=this._stack[this._ptr-1],e=new UndoActionEventArgs(t);this.onUndoingAction(e)&&(this._ptr--,this._undoing=!0,t.undo(),this._undoing=!1,this._pendingAction=null,this.onUndoneAction(e),this.onStateChanged())}}redo(){if(this.canRedo){let t=this._stack[this._ptr],e=new UndoActionEventArgs(t);this.onRedoingAction(e)&&(this._ptr++,this._undoing=!0,t.redo(),this._undoing=!1,this._pendingAction=null,this.onRedoneAction(e),this.onStateChanged())}}clear(){this._ptr=0,this._stack.splice(0,this._stack.length),this.onStateChanged()}onAddingTarget(t){return this.addingTarget.raise(this,t),!t.cancel}onAddedTarget(t){this.addedTarget.raise(this,t)}onAddingAction(t){return this.addingAction.raise(this,t),!t.cancel}onAddedAction(t){this.addedAction.raise(this,t)}onUndoingAction(t){return this.undoingAction.raise(this,t),!t.cancel}onUndoneAction(t){this.undoneAction.raise(this,t)}onRedoingAction(t){return this.redoingAction.raise(this,t),!t.cancel}onRedoneAction(t){this.redoneAction.raise(this,t)}onStateChanged(){this.stateChanged.raise(this,EventArgs.empty)}pushPendingAction(){if(!this._disabled&&!this._undoing&&this._pendingAction&&this._pendingAction.close()){if(this._stack.splice(this._ptr,this._stack.length-this._ptr),assert(this._stack.length==this._ptr,"should be at the end of the stack"),this._stack.length){let t=this._stack[this._ptr-1];if(t.shouldAddAsChildAction(this._pendingAction))return t.addChildAction(this._pendingAction),this._pendingAction=null,void this.onStateChanged()}let t=new UndoActionEventArgs(this._pendingAction);if(!this.onAddingAction(t))return;this._stack.push(this._pendingAction),this._ptr++,this._pendingAction=null;let e=this._stack.length-this._maxActions;e>0&&(this._stack.splice(0,e),this._ptr-=e,assert(this._ptr>=0,"pointer should not be negative")),this.onStateChanged()}}};export class AddTargetEventArgs extends CancelEventArgs{constructor(t){super(),this._target=t}get target(){return this._target}};export class UndoActionEventArgs extends CancelEventArgs{constructor(t){super(),this._action=t}get action(){return this._action}};export function softInput(){return _getModule("wijmo.input")};export function softGrid(){return _getModule("wijmo.grid")};export function softGauge(){return _getModule("wijmo.gauge")};export class _UndoStackWijmo{static addTarget(t,e){return softGrid()&&e instanceof softGrid().FlexGrid?_UndoStackWijmo._addFlexGrid(t,e):softGauge()&&e instanceof softGauge().Gauge?_UndoStackWijmo._addGauge(t,e):!!e.hostElement.querySelector("input")&&_UndoStackWijmo._addInputControl(t,e)}static _addInputControl(t,e){let n=e.hostElement,i=n.querySelector("input");assert(null!=i,"We need a control with an input element"),n.addEventListener("focus",()=>{t._pendingAction instanceof InputControlChangeAction&&t._pendingAction.target==i||(t._pendingAction=new InputControlChangeAction({target:i}))},!0),n.addEventListener("blur",()=>{t._pendingAction instanceof InputControlChangeAction&&!e.containsFocus()&&t.pushPendingAction()},!0);let o=e.dropDown;return null!=o&&o.addEventListener("blur",n=>{t._pendingAction instanceof InputControlChangeAction&&!e.containsFocus()&&t.pushPendingAction()},!0),!0}static _addGauge(t,e){if(!(softGauge()&&e instanceof softGauge().Gauge))return!1;let n=e.hostElement;n.addEventListener("focus",()=>{t._pendingAction instanceof GaugeChangeAction&&t._pendingAction.target==e||(t._pendingAction=new GaugeChangeAction(e))},!0),n.addEventListener("blur",()=>{t._pendingAction instanceof GaugeChangeAction&&!e.containsFocus()&&t.pushPendingAction()},!0)}static _addFlexGrid(t,e){return!!(softGrid()&&e instanceof softGrid().FlexGrid)&&(e.beginningEdit.addHandler((e,n)=>{t._pendingAction=new GridEditAction(e,n)}),e.cellEditEnded.addHandler((e,n)=>{t._pendingAction instanceof GridEditAction&&t.pushPendingAction()}),e.pastingCell.addHandler((e,n)=>{t._pendingAction=new GridEditAction(e,n)}),e.pastedCell.addHandler((e,n)=>{t._pendingAction instanceof GridEditAction&&t.pushPendingAction()}),e.sortingColumn.addHandler((e,n)=>{t._pendingAction=new GridSortAction(e,n)}),e.sortedColumn.addHandler((e,n)=>{t._pendingAction instanceof GridSortAction&&t.pushPendingAction()}),e.resizingColumn.addHandler((e,n)=>{t._pendingAction instanceof GridResizeAction&&t._pendingAction.target==e||(t._pendingAction=new GridResizeAction(e,n))}),e.resizedColumn.addHandler(()=>{t._pendingAction instanceof GridResizeAction&&t.pushPendingAction()}),e.autoSizingColumn.addHandler((e,n)=>{t._pendingAction=new GridResizeAction(e,n)}),e.autoSizedColumn.addHandler(()=>{t._pendingAction instanceof GridResizeAction&&t.pushPendingAction()}),e.draggingColumn.addHandler((e,n)=>{t._pendingAction=new GridDragAction(e,n)}),e.draggedColumn.addHandler((e,n)=>{t._pendingAction instanceof GridDragAction&&t.pushPendingAction()}),e.rowAdded.addHandler((e,n)=>{n.cancel||(t._pendingAction=new GridAddRowAction(e,n),t.pushPendingAction())}),e.deletingRow.addHandler((e,n)=>{n.cancel||(t._pendingAction=new GridRemoveRowAction(e,n),t.pushPendingAction())}),!0)}};class InputControlChangeAction extends InputChangeAction{constructor(t){super(t),this._ctl=Control.getControl(closest(t.target,".wj-control")),softInput()&&(this._ctl instanceof softInput().MultiSelect?this._oldState=this._ctl.checkedItems.slice(0):this._ctl instanceof softInput().MultiAutoComplete&&(this._oldState=this._ctl.selectedItems.slice(0)))}close(){if(softInput()){if(this._ctl instanceof softInput().MultiSelect)return this._newState=this._ctl.checkedItems.slice(0),!this._sameContent(this._oldState,this._newState);if(this._ctl instanceof softInput().MultiAutoComplete)return this._newState=this._ctl.selectedItems.slice(0),!this._sameContent(this._oldState,this._newState)}return super.close()}applyState(t){softInput()&&this._ctl instanceof softInput().MultiSelect?this._ctl.checkedItems=t:softInput()&&this._ctl instanceof softInput().MultiAutoComplete?this._ctl.selectedItems=t:super.applyState(t)}_sameContent(t,e){if(t.length!=e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!=e[n])return!1;return!0}}class GaugeChangeAction extends UndoableAction{constructor(t){super(t),this._oldState=t.value}close(){return this._newState=this._target.value,this._newState!=this._oldState}applyState(t){this._target.value=t}}class GridEditAction extends UndoableAction{constructor(t,e){super(t),this._row=e.row,this._col=e.col,this._dataItem=t.rows[e.row].dataItem,this._oldState=t.getCellData(e.row,e.col,!1)}close(){let t=this._target.collectionView;return(!t||!t.currentAddItem)&&(this._timeStamp=Date.now(),this._newState=this._target.getCellData(this._row,this._col,!1),this._newState!=this._oldState)}applyState(t){let e=this._row,n=this._target,i=n.rows;if(this._dataItem&&i[e].dataItem!=this._dataItem){e=-1;for(let t=0;t<i.length;t++)if(i[t].dataItem==this._dataItem){e=t;break}}e>-1&&(n.setCellData(e,this._col,t,!1),n.select(e,this._col),n.focus())}shouldAddAsChildAction(t){return t instanceof GridEditAction&&t.target==this.target&&t._timeStamp-this._timeStamp<100}}class GridSortAction extends UndoableAction{constructor(t,e){super(t);let n=this._target.collectionView;n&&(this._oldState=n.sortDescriptions.slice())}close(){let t=this._target.collectionView;return!!t&&(this._newState=t.sortDescriptions.slice(),!0)}applyState(t){let e=this._target.collectionView;e&&e.deferUpdate(()=>{let n=e.sortDescriptions;n.clear(),t.forEach(t=>{n.push(t)})})}}class GridResizeAction extends UndoableAction{constructor(t,e){super(t),this._col=t.columns[e.col],this._oldState=this._col.renderWidth}close(){return this._newState=this._col.renderWidth,this._newState!=this._oldState}applyState(t){this._col.width=t}}class GridDragAction extends UndoableAction{constructor(t,e){super(t),this._col=t.columns[e.col],this._oldState=t.columns.indexOf(this._col)}close(){return this._newState=this._col.grid.columns.indexOf(this._col),this._newState!=this._oldState}applyState(t){let e=this._col.grid.columns;e.deferUpdate(()=>{e.remove(this._col),e.insert(t,this._col)})}}class GridAddRowAction extends UndoableAction{constructor(t,e){super(t);let n=this._target.collectionView;if(n&&n.currentAddItem){let t=n.currentAddItem,e=n.sourceCollection.indexOf(t),i=n.currentPosition;this._oldState={item:t,index:e,position:i},this._newState={index:e,position:i}}}close(){return null!=this._oldState}applyState(t){let e=this._target.collectionView;if(e){let n=e.sourceCollection;if(t.item){if(n.splice(t.index,1),e instanceof CollectionView&&e.trackChanges){let n=t.item;assert(e.itemsAdded.indexOf(n)>-1,"item should be in the itemsAdded list"),e.itemsAdded.remove(n)}}else{let i=this._oldState.item;n.splice(t.index,0,i),e instanceof CollectionView&&e.trackChanges&&(assert(e.itemsAdded.indexOf(i)<0,"item should not be in the itemsAdded list"),e.itemsAdded.push(i))}e.refresh(),e.moveCurrentToPosition(t.position)}}}class GridRemoveRowAction extends UndoableAction{constructor(t,e){super(t);let n=this._target.collectionView;if(n){let i=t.rows[e.row].dataItem,o=n.sourceCollection.indexOf(i),s=n.currentPosition;this._oldState={item:i,index:o,position:s},this._newState={index:o,position:s}}}close(){return null!=this._oldState}applyState(t){let e=this._target.collectionView;if(e){let n=e.sourceCollection;if(t.item){if(n.splice(t.index,0,t.item),e instanceof CollectionView&&e.trackChanges){let n=t.item;assert(e.itemsRemoved.indexOf(n)>-1,"item should be in the itemsRemoved list"),e.itemsRemoved.remove(n)}}else if(n.splice(t.index,1),e instanceof CollectionView&&e.trackChanges){let t=this._oldState.item;assert(e.itemsRemoved.indexOf(t)<0,"item should not be in the itemsRemoved list"),e.itemsRemoved.push(t)}e.refresh(),e.moveCurrentToPosition(t.position);let i=new(softGrid().CellRange)(t.position,0,t.position,this.target.columns.length-1);this.target.select(i)}}}_registerModule("wijmo.undo",selfModule);