/*!
    *
    * Wijmo Library 5.20192.631
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{_getModule,Globalize,DataType,isString,isNumber,isInt,isDate,isFunction,isNullOrWhiteSpace,isObject,tryCast,asEnum,getType,copy,_registerModule}from"wijmo/wijmo";import{FlexGrid,Row,GroupRow,Column,CellRange,CellRangeEventArgs,RowColFlags,CellType,_NewRowTemplate}from"wijmo/wijmo.grid";import*as mXlsx from"wijmo/wijmo.xlsx";import*as selfModule from"wijmo/wijmo.grid.xlsx";export function softDetail(){return _getModule("wijmo.grid.detail")};export function softMultiRow(){return _getModule("wijmo.grid.multirow")};export class FlexGridXlsxConverter{static save(e,l,t){var o=this._saveFlexGridToWorkbook(e,l);return t&&o.save(t),o}static saveAsync(e,l,t,o,r){var s=this._saveFlexGridToWorkbook(e,l);return t&&s.saveAsync(t,o,r),s}static load(e,l,t){if(l instanceof Blob){var o=new FileReader;o.onload=(()=>{var l=mXlsx.Workbook._base64EncArr(new Uint8Array(o.result)),r=new mXlsx.Workbook;r.load(l),l=null,e.deferUpdate(()=>{this._loadToFlexGrid(e,r,t),r=null})}),o.readAsArrayBuffer(l)}else if(l instanceof mXlsx.Workbook)e.deferUpdate(()=>{this._loadToFlexGrid(e,l,t),l=null});else{if(l instanceof ArrayBuffer)l=mXlsx.Workbook._base64EncArr(new Uint8Array(l));else if(!isString(l))throw"Invalid workbook.";var r=new mXlsx.Workbook;r.load(l),l=null,e.deferUpdate(()=>{this._loadToFlexGrid(e,r,t),r=null})}}static loadAsync(e,l,t,o,r){if(l instanceof Blob){var s=new FileReader;s.onload=(()=>{var l=mXlsx.Workbook._base64EncArr(new Uint8Array(s.result)),n=new mXlsx.Workbook;n.loadAsync(l,r=>{l=null,n=null,e.deferUpdate(()=>{this._loadToFlexGrid(e,r,t),o&&o(r),r=null})},r)}),s.readAsArrayBuffer(l)}else if(l instanceof mXlsx.Workbook)e.deferUpdate(()=>{this._loadToFlexGrid(e,l,t),o&&o(l),l=null});else{if(l instanceof ArrayBuffer)l=mXlsx.Workbook._base64EncArr(new Uint8Array(l));else if(!isString(l))throw"Invalid workbook.";(new mXlsx.Workbook).loadAsync(l,r=>{l=null,e.deferUpdate(()=>{this._loadToFlexGrid(e,r,t),o&&o(r),r=null})},r)}}static _saveFlexGridToWorkbook(e,l){var t,o,r,s,n,a,i,d,u,c,m,h,f,p,g=new mXlsx.Workbook,w=new mXlsx.WorkSheet,x=(new mXlsx.WorkbookStyle,new mXlsx.WorkbookFrozenPane),b=!l||null==l.includeColumnHeaders||l.includeColumnHeaders,y=!(!l||null==l.includeRowHeaders)&&l.includeRowHeaders,_=!l||null==l.includeCellStyles||l.includeCellStyles,C=l?l.activeWorksheet:null,k=l?l.includeColumns:null,S=l?l.formatItem:null,v=0,T=0,R=0,W=[];if(null==this.hasCssText&&(this.hasCssText="cssText"in document.body.style),c=e.wj_sheetInfo,w.name=l?l.sheetName:"",w.visible=!l||!1!==l.sheetVisible,c&&c.tables&&c.tables.length>0)for(var X=0;X<c.tables.length;X++)w.tables.push(c.tables[X]);if(a=[],c||!_&&!S||((m=document.createElement("div")).style.visibility="hidden",m.setAttribute(FlexGrid._WJS_MEASURE,"true"),e.hostElement.appendChild(m)),y){for(d=0,i=0;i<e.rowHeaders.rows.length;i++)if(!(e.rowHeaders.rows[i].renderSize<=0)){for(a[d]=[],u=0;u<e.rowHeaders.columns.length;u++)r=e._getBindingColumn(e.rowHeaders,i,e.rowHeaders.columns[u]),(s=this._getColumnSetting(r,u,e.columnHeaders.columns))&&(a[d][u]=s,0===d&&((n=new mXlsx.WorkbookColumn)._deserialize(s),w._addWorkbookColumn(n,u)));d++}R=u}if(e.columnHeaders.rows.length>0){for(d=0,i=0;i<e.columnHeaders.rows.length;i++)if(!(e.columnHeaders.rows[i].renderSize<=0)){a[d]||(a[d]=[]);for(let l=0,t=0;l<e.columnHeaders.columns.length;l++)r=e._getBindingColumn(e.columnHeaders,i,e.columnHeaders.columns[l]),(s=this._getColumnSetting(r,l,e.columnHeaders.columns))&&(a[d][R+l]=s,0===d&&(k&&!k(r)||((n=new mXlsx.WorkbookColumn)._deserialize(s),w._addWorkbookColumn(n,R+t++))));b&&(R=0,t={},o=new mXlsx.WorkbookRow,y&&(R=this._parseFlexGridRowToSheetRow(e.topLeftCells,t,i,0,a,_,m,W,!1,0,k,S)),this._parseFlexGridRowToSheetRow(e.columnHeaders,t,i,R,a,_,m,W,!1,0,k,S),t.cells.length>0&&(o._deserialize(t),w._addWorkbookRow(o,d))),d++}T=b?d:0}for(i=0;i<e.cells.rows.length;i++)R=0,t={},o=new mXlsx.WorkbookRow,(h=e.rows[i])instanceof _NewRowTemplate||((f=h instanceof GroupRow)?v=tryCast(h,GroupRow).level:e.rows.maxGroupLevel>-1&&(v=e.rows.maxGroupLevel+1),y&&(R=this._parseFlexGridRowToSheetRow(e.rowHeaders,t,i,0,a,_,m,W,f,v,k,S)),this._parseFlexGridRowToSheetRow(e.cells,t,i,R,a,_,m,W,f,v,k,S),t.cells.length>0&&(o._deserialize(t),w._addWorkbookRow(o,T+i)));for(p=e.cells.rows.length,i=0;i<e.columnFooters.rows.length;i++)R=0,t={},o=new mXlsx.WorkbookRow,f=(h=e.columnFooters.rows[i])instanceof GroupRow,y&&(R=this._parseFlexGridRowToSheetRow(e.rowHeaders,t,i,0,a,_,m,W,f,0,k,S)),this._parseFlexGridRowToSheetRow(e.columnFooters,t,i,R,a,_,m,W,f,0,k,S),t.cells.length>0&&(o._deserialize(t),w._addWorkbookRow(o,T+p+i));return x.rows=b?e.frozenRows+T:e.frozenRows,x.columns=y?e.frozenColumns+R:e.frozenColumns,w.frozenPane=x,g._addWorkSheet(w),c||!_&&!S||(e.hostElement.removeChild(m),W.forEach(e=>e.forEach(e=>{e&&e.parentElement&&e.parentElement.removeChild(e)}))),g.activeWorksheet=C,g}static _loadToFlexGrid(e,l,t){t=t||{};let o,r=null!=e.wj_sheetInfo,s={},n=[],a=[],i={};e.itemsSource=null,e.columns.clear(),e.columnHeaders.rows.clear(),e.rows.clear(),e.frozenColumns=0,e.frozenRows=0;let d=null==t.sheetIndex||isNaN(t.sheetIndex)?0:t.sheetIndex;if(d<0||d>=l.sheets.length)throw"The sheet index option is out of the sheet range of current workbook.";if(null!=t.sheetName)for(let e=0;e<l.sheets.length;e++)if(t.sheetName===l.sheets[e].name){o=l.sheets[e];break}if(null==(o=o||l.sheets[d]).rows)return;let u=this._getColumnCount(o.rows),c=this._getRowCount(o.rows,u),m=o.columns;for(let l=0;l<u;l++)e.columns.push(new Column),m[l]&&(isNaN(+m[l].width)||(e.columns[l].width=+m[l].width),m[l].visible||null==m[l].visible||(e.columns[l].visible=!!m[l].visible),m[l].style&&m[l].style.wordWrap&&(e.columns[l].wordWrap=m[l].style.wordWrap));let h,f=(null==t.includeColumnHeaders||t.includeColumnHeaders)&&o.rows.length>0,p=f?this._getColumnHeadersHeight(o):0,g=!1,w=[];for(let l=p;l<c;l++){let t=!1,d=null,c=o.rows[l];if(c){let e=l+1;for(;e<o.rows.length;){let l=o.rows[e];if(l){(isNaN(c.groupLevel)&&!isNaN(l.groupLevel)||!isNaN(c.groupLevel)&&c.groupLevel<l.groupLevel)&&(t=!0);break}e++}}if(t&&!o.summaryBelow)h&&(h.isCollapsed=g),(h=new GroupRow).isReadOnly=!1,g=null!=c.collapsed&&c.collapsed,h.level=isNaN(c.groupLevel)?0:c.groupLevel,i[h.level]=g,this._checkParentCollapsed(i,h.level)&&h._setFlag(RowColFlags.ParentCollapsed,!0),e.rows.push(h);else{let l=new Row;c&&this._checkParentCollapsed(i,c.groupLevel)&&l._setFlag(RowColFlags.ParentCollapsed,!0),e.rows.push(l)}c&&c.height&&!isNaN(c.height)&&(e.rows[l-p].height=c.height);for(let o=0;o<u;o++)if(c){let i=c.cells[o],m=i?i.formula:null;m&&"="!==m[0]&&(m="="+m),i&&i.textRuns&&i.textRuns.length>0?(e.rows[l-p].isContentHtml=!0,e.setCellData(l-p,o,this._parseTextRunsToHTML(i.textRuns))):e.setCellData(l-p,o,m&&r?m:this._getItemValue(i)),t||this._setColumn(w,o,i);let h,f=l*u+o,g=i?i.style:null,x=mXlsx.Workbook._parseExcelFormat(i);if(g){if(d=null==d?!!g.wordWrap:d&&!!g.wordWrap,g.hAlign)h=mXlsx.Workbook._parseHAlignToString(asEnum(g.hAlign,mXlsx.HAlign));else switch(this._getItemType(i)){case DataType.Number:h="right";break;case DataType.Boolean:h="center";break;default:h=x&&0===x.search(/[n,c,p]/i)?"right":"left"}s[f]={fontWeight:g.font&&g.font.bold?"bold":"none",fontStyle:g.font&&g.font.italic?"italic":"none",textDecoration:g.font&&g.font.underline?"underline":"none",textAlign:h,fontFamily:g.font&&g.font.family?g.font.family:"",fontSize:g.font&&g.font.size?g.font.size+"px":"",color:g.font&&g.font.color?g.font.color:"",backgroundColor:g.fill&&g.fill.color?g.fill.color:"",whiteSpace:g.wordWrap?"pre-wrap":"normal",format:x},g.borders&&(g.borders.left&&(this._parseBorderStyle(g.borders.left.style,"Left",s[f]),s[f].borderLeftColor=g.borders.left.color),g.borders.right&&(this._parseBorderStyle(g.borders.right.style,"Right",s[f]),s[f].borderRightColor=g.borders.right.color),g.borders.top&&(this._parseBorderStyle(g.borders.top.style,"Top",s[f]),s[f].borderTopColor=g.borders.top.color),g.borders.bottom&&(this._parseBorderStyle(g.borders.bottom.style,"Bottom",s[f]),s[f].borderBottomColor=g.borders.bottom.color)),g.font&&-1===a.indexOf(g.font.family)&&a.push(g.font.family)}i&&isNumber(i.rowSpan)&&i.rowSpan>0&&isNumber(i.colSpan)&&i.colSpan>0&&(i.rowSpan>1||i.colSpan>1)&&n.push(new CellRange(l,o,l+i.rowSpan-1,o+i.colSpan-1))}c&&(this._checkParentCollapsed(i,c.groupLevel)||c.visible||null==c.visible||(e.rows[l-p].visible=c.visible),e.rows[l-p].wordWrap=!!c.style&&!!c.style.wordWrap||!!d)}if(h&&(h.isCollapsed=g),o.frozenPane){let l=o.frozenPane.columns;isNumber(l)&&!isNaN(l)&&(e.frozenColumns=l);let t=o.frozenPane.rows;isNumber(t)&&!isNaN(t)&&(e.frozenRows=f&&t>0?t-1:t)}for(let l=0;l<e.columnHeaders.columns.length;l++){let t=w[l],o=e.columns[l];o.isRequired=!1,t&&(t.dataType===DataType.Boolean&&(o.dataType=t.dataType),o.format=t.format,o.align=t.hAlign,o.wordWrap=o.wordWrap||!!t.wordWrap)}for(let l=0;l<Math.max(p,1);l++)e.columnHeaders.rows.push(new Row);let x=Object.keys(o.rows);for(let l=0;l<p;l++)for(let t=0;t<o.columns.length;t++){let r=o.rows[x[l]].cells[t],s=r&&r.value||"",n=e.columnHeaders.columns[t];if(s){let e=mXlsx.Workbook._parseExcelFormat(r);s=Globalize.format(s,e)}n.header=n.header||s,e.columnHeaders.setCellData(l,t,s)}if(r){let l=null==t.sheetVisible||t.sheetVisible;e.wj_sheetInfo.name=o.name,e.wj_sheetInfo.visible=!0===l||!1!==o.visible,e.wj_sheetInfo.styledCells=s,e.wj_sheetInfo.mergedRanges=n,e.wj_sheetInfo.fonts=a,e.wj_sheetInfo.tables=o.tables}}static _getColumnHeadersHeight(e){if(!e&&!e.rows.length)return 0;let l=1;for(var t=0;t<e.rows.length;t++){var o=e.rows[t];if(o){o.cells.forEach(e=>{l=Math.max(l,e.rowSpan||0)});break}}return l}static _escapePlainText(e){return""===e?"'":e&&"'"===e[0]?"'"+e:e}static _parseFlexGridRowToSheetRow(e,l,t,o,r,s,n,a,i,d,u,c){var m,h,f,p,g,w,x,b,y,_,C,k,S,v,T,R,W,X,A,F,H,D,N,B,E,I,G,M,z,L,j=!1,O=!1;for((A=(m=e.grid).wj_sheetInfo)&&(F=A.evaluateFormula),null==(h=e.rows[t]).recordIndex?(B=0,e.cellType===CellType.ColumnHeader&&e.rows.length>1&&(B=t===r.length?t-1:t)):B=h.recordIndex,l.cells||(l.cells=[]),l.visible=h.isVisible,l.height=h.renderHeight||e.rows.defaultSize,l.groupLevel=d,i&&(l.collapsed=h.isCollapsed),h.wordWrap&&(l.style={wordWrap:h.wordWrap}),(h.constructor===Row||h.constructor===_NewRowTemplate||softDetail()&&h.constructor===softDetail().DetailRow||softMultiRow()&&h.constructor===softMultiRow()._MultiRow)&&(j=!0),softDetail()&&h.constructor===softDetail().DetailRow&&(O=!0),p=0;p<e.columns.length;p++)if(g=null,X=1,W=1,z=0,N=!1,T=null,G=null,I=null,b=null,D=m._getBindingColumn(e,t,e.columns[p]),R=null,A&&e===m.cells?(v=t*e.columns.length+p,A.mergedRanges&&(R=this._getMergedRange(t,p,A.mergedRanges)),A.styledCells&&(T=A.styledCells[v])):s&&(I=this._getMeasureCell(e,p,n,a),T=(R=m.getMergedRange(e,t,p,!1))?this._getCellStyle(e,I,R.bottomRow,R.rightCol)||{}:this._getCellStyle(e,I,t,p)||{}),R||(R=m.getMergedRange(e,t,p,!1)),R?t===R.topRow&&p===R.leftCol&&(W=R.bottomRow-R.topRow+1,X=this._getColSpan(e,R,u),N=!0):N=!0,!u||u(D)){if(f=r[B]?r[B][p+o]:null,j||i?(x=N?e.getCellData(t,p,!0):null,y=N?e.getCellData(t,p,!1):null,C=!1,S=null,x&&isString(x)&&x.length>1&&"="===x[0]&&(C=!0),H=isDate(y),T&&T.format&&null!=y?(g=T.format,/[hsmyt\:]/i.test(g)&&(H=!0),w=mXlsx.Workbook._parseCellFormat(T.format,H)):f&&f.style&&f.style.format?(g=D.format,w=f.style.format):w=null,C&&null!=F&&isFunction(F)&&(S=F(x)),w||(H?w="m/d/yyyy":isNumber(y)&&!D.dataMap?w=isInt(y)?"#,##0":"#,##0.00":C?(k=x.toLowerCase()).indexOf("now()")>-1?(w="m/d/yyyy h:mm",H=!0):k.indexOf("today()")>-1||k.indexOf("date(")>-1?(w="m/d/yyyy",H=!0):k.indexOf("time(")>-1&&(w="h:mm AM/PM",H=!0):w="General")):(x=N?m.columnHeaders.getCellData(0,p,!0):null,w="General"),isString(x)&&-1!==x.indexOf("<span")&&(b=this._parseToTextRuns(x),x=null),G=this._parseCellStyle(T)||{},e===m.cells&&i&&h.hasChildren&&p===m.columns.firstVisibleIndex){if(C&&null!=S?_=S:x?_=x:N&&(_=h.getGroupHeader().replace(/<\/?\w+>/g,"").replace(/&#39;/g,"'")),null==_&&!T)continue;!(H=isDate(_))&&g&&"d"===g.toLowerCase()&&isInt(_)&&(w="0"),_=isString(_)?mXlsx.Workbook._unescapeXML(_):_,p===m.columns.firstVisibleIndex&&m.treeIndent&&(z=d),E={value:_,isDate:H,formula:C?this._parseToExcelFormula(x,H):null,colSpan:X,rowSpan:W,style:this._extend(G,{format:w,font:{bold:!0},hAlign:mXlsx.HAlign.Left,indent:z}),textRuns:b}}else x=isString(x)?mXlsx.Workbook._unescapeXML(x):x,y=isString(y)?mXlsx.Workbook._unescapeXML(y):y,!H&&g&&"d"===g.toLowerCase()&&isInt(y)&&(w="0"),M=G&&G.hAlign?G.hAlign:f&&f.style&&null!=f.style.hAlign?asEnum(f.style.hAlign,mXlsx.HAlign,!0):isDate(y)?mXlsx.HAlign.Left:mXlsx.HAlign.General,p!==m.columns.firstVisibleIndex||!m.treeIndent||M!==mXlsx.HAlign.Left&&M!==mXlsx.HAlign.General||(z=d),E={value:C?S:"General"===w?this._escapePlainText(x):this._escapePlainText(y),isDate:H,formula:C?this._parseToExcelFormula(x,H):null,colSpan:p<m.columns.firstVisibleIndex?1:X,rowSpan:W,style:this._extend(G,{format:w,hAlign:M,vAlign:W>1?e===m.cells||!1===m.centerHeadersVertically?mXlsx.VAlign.Top:mXlsx.VAlign.Center:null,indent:z}),textRuns:b},O&&(L=e.getCellElement(t,p))&&L.appendChild(h.detail);c&&c(new XlsxFormatItemEventArgs(e,new CellRange(t,p),I,n,a,E)),l.cells.push(E)}return o+p}static _parseCellStyle(e,l=!1){if(null==e)return null;var t=e.fontSize;t=t?+t.substring(0,t.indexOf("px")):null,isNaN(t)&&(t=null);var o=e.fontWeight;o="bold"===o||+o>=700;var r="italic"===e.fontStyle,s=e.textDecorationStyle;null==s&&(s=e.textDecoration),s="underline"===s;var n=e.whiteSpace;return n=!!n&&n.indexOf("pre")>-1,{font:{bold:o,italic:r,underline:s,family:this._parseToExcelFontFamily(e.fontFamily),size:t,color:e.color},fill:{color:e.backgroundColor},borders:this._parseBorder(e,l),hAlign:mXlsx.Workbook._parseStringToHAlign(e.textAlign),wordWrap:n}}static _parseBorder(e,l){var t={};return t.left=this._parseEgdeBorder(e,"Left"),t.right=this._parseEgdeBorder(e,"Right"),t.top=this._parseEgdeBorder(e,"Top"),t.bottom=this._parseEgdeBorder(e,"Bottom"),l&&(t.vertical=this._parseEgdeBorder(e,"Vertical"),t.horizontal=this._parseEgdeBorder(e,"Horizontal")),t}static _parseEgdeBorder(e,l){var t,o=e["border"+l+"Style"],r=e["border"+l+"Width"];if(r&&r.length>2&&(r=+r.substring(0,r.length-2)),o&&"none"!==o&&"hidden"!==o){switch(t={},o=o.toLowerCase()){case"dotted":t.style=r>1?mXlsx.BorderStyle.MediumDashDotted:mXlsx.BorderStyle.Dotted;break;case"dashed":t.style=r>1?mXlsx.BorderStyle.MediumDashed:mXlsx.BorderStyle.Dashed;break;case"double":t.style=mXlsx.BorderStyle.Double;break;default:t.style=r>2?mXlsx.BorderStyle.Thick:r>1?mXlsx.BorderStyle.Medium:mXlsx.BorderStyle.Thin}t.color=e["border"+l+"Color"]}return t}static _parseBorderStyle(e,l,t){var o="border"+l+"Style",r="border"+l+"Width";switch(e){case mXlsx.BorderStyle.Dotted:case mXlsx.BorderStyle.Hair:t[o]="dotted",t[r]="1px";break;case mXlsx.BorderStyle.Dashed:case mXlsx.BorderStyle.ThinDashDotDotted:case mXlsx.BorderStyle.ThinDashDotted:t[o]="dashed",t[r]="1px";break;case mXlsx.BorderStyle.MediumDashed:case mXlsx.BorderStyle.MediumDashDotDotted:case mXlsx.BorderStyle.MediumDashDotted:case mXlsx.BorderStyle.SlantedMediumDashDotted:t[o]="dashed",t[r]="2px";break;case mXlsx.BorderStyle.Double:t[o]="double",t[r]="3px";break;case mXlsx.BorderStyle.Medium:t[o]="solid",t[r]="2px";break;default:t[o]="solid",t[r]="1px"}}static _parseToExcelFontFamily(e){var l;return e&&(l=e.split(","))&&l.length>0&&(e=l[0].replace(/\"|\'/g,"")),e}static _parseToExcelFormula(e,l){var t,o,r,s,n,a,i,d=/\"?\w+\"?\s*\,\s*\"(\w+)\"/i;if(t=e.match(/(floor|ceiling)\([+-]?\d+\.?\d*\)/gi))for(n=0;n<t.length;n++)i=(a=t[n]).substring(0,a.lastIndexOf(")"))+", 1)",e=e.replace(a,i);if(t=null,t=e.match(/text\(\"?\w+\"?\s*\,\s*\"\w+\"\)/gi))for(n=0;n<t.length;n++)(o=(a=t[n]).match(d))&&2===o.length&&(r=o[1],/^d{1,4}?$/.test(r)||(s=mXlsx.Workbook._parseCellFormat(r,l),i=a.replace(r,s),e=e.replace(a,i)));return e}static _parseToTextRuns(e){var l,t,o,r=e.split("<span "),s=[];for(l=0;l<r.length;l++)o=-1!==(t=r[l]).indexOf("</span>")?{text:t.substring(t.indexOf(">")+1,t.indexOf("</span>")),font:this._parseToTextRunFont(t.substring(t.indexOf('style="')+7,t.indexOf(';"')))}:{text:t},s.push(o);return s}static _parseToTextRunFont(e){var l,t,o,r,s,n,a,i,d,u=e.split(";");if(u.length>0){for(l=0;l<u.length;l++)if(2===(t=u[l].split(":")).length)switch(t[1]=t[1].trim(),t[0]){case"font-size":n=+t[1].substring(0,t[1].indexOf("px")),isNaN(n)&&(n=null);break;case"font-weight":o="bold"===t[1]||+t[1]>=700;break;case"font-style":r="italic"===t[1];break;case"text-decoration-style":case"text-decoration":s="underline"===t[1];break;case"font-family":a=this._parseToExcelFontFamily(t[1]);break;case"color":i=t[1]}d={bold:o,italic:r,underline:s,family:a,size:n,color:i}}return d}static _getMeasureCell(e,l,t,o){let r=o[e.cellType],s=r&&r[l],n=null==s;if(s){if(this.hasCssText){s.style;s.style.cssText="",s.style.visibility="hidden"}}else r||(o[e.cellType]=r=[]),r[l]=s=t.cloneNode();return!n&&s.parentElement||(e.hostElement.children.length>0?e.hostElement.children[0].appendChild(s):e.hostElement.appendChild(s)),s}static _getColumnSetting(e,l,t){let o=e;return null!=e.colspan&&(o=this._getRenderColumn(l,t)),o?{autoWidth:!0,width:o.renderWidth||t.defaultSize,visible:o.visible,style:{format:e.format?mXlsx.Workbook._parseCellFormat(e.format,e.dataType===DataType.Date):"",hAlign:mXlsx.Workbook._parseStringToHAlign(this._toExcelHAlign(e.getAlignment())),wordWrap:e.wordWrap}}:null}static _toExcelHAlign(e){return(e=e?e.trim().toLowerCase():e)?e.indexOf("center")>-1?"center":e.indexOf("right")>-1||e.indexOf("end")>-1?"right":e.indexOf("justify")>-1?"justify":"left":e}static _getColumnCount(e){for(var l,t=0,o=0,r=0;r<e.length;r++)(l=e[r]&&e[r].cells?e[r].cells:[])&&l.length>0&&(o=l.length,isInt(l[o-1].colSpan)&&l[o-1].colSpan>1&&(o=o+l[o-1].colSpan-1),o>t&&(t=o));return t}static _getRowCount(e,l){for(var t,o,r=e.length,s=r-1,n=0;n<l;n++)e:for(;s>=0;s--)if((o=((t=e[s])&&t.cells?t.cells:[])[n])&&(null!=o.value&&""!==o.value||isInt(o.rowSpan)&&o.rowSpan>1)){isInt(o.rowSpan)&&o.rowSpan>1&&s+o.rowSpan>r&&(r=s+o.rowSpan);break e}return r}static _numAlpha(e){var l=Math.floor(e/26)-1;return(l>-1?this._numAlpha(l):"")+String.fromCharCode(65+e%26)}static _getItemType(e){return null==e||null==e.value||isNaN(e.value)?null:getType(e.value)}static _setColumn(e,l,t){var o,r,s,n=e[l];n?(o=this._getItemType(t),n.dataType!==o&&n.dataType===DataType.Boolean&&o!==DataType.Boolean&&(n.dataType=o),!t||null==t.value||isString(t.value)&&isNullOrWhiteSpace(t.value)||(r=mXlsx.Workbook._parseExcelFormat(t))&&n.format!==r&&"General"!==r&&(n.format=r),t&&t.style&&(t.style.hAlign&&(s=mXlsx.Workbook._parseHAlignToString(asEnum(t.style.hAlign,mXlsx.HAlign))),null==n.wordWrap?n.wordWrap=!!t.style.wordWrap:n.wordWrap=n.wordWrap&&!!t.style.wordWrap),s||o!==DataType.Number||(s="right"),n.hAlign=s):e[l]={dataType:this._getItemType(t),format:mXlsx.Workbook._parseExcelFormat(t),hAlign:"",wordWrap:null}}static _getItemValue(e){if(null==e||null==e.value)return null;var l=e.value;return isString(l)&&"'"===l[0]&&(l=l.substr(1)),isNumber(l)&&isNaN(l)?"":l instanceof Date&&isNaN(l.getTime())?"":l}static _getCellStyle(e,l,t,o){try{e.grid.cellFactory.updateCell(e,t,o,l),l.className=l.className.replace("wj-state-selected",""),l.className=l.className.replace("wj-state-multi-selected","")}catch(e){return null}return window.getComputedStyle(l)}static _parseTextRunsToHTML(e){var l,t,o,r;for(o="",r=0;r<e.length;r++)o+=(t=(l=e[r]).font)?'<span style="'+(t.bold?"font-weight: bold;":"")+(t.italic?"font-style: italic;":"")+(t.underline?"text-decoration: underline;":"")+(t.family?"font-family: "+t.family+";":"")+(null!=t.size?"font-size: "+t.size+"px;":"")+(t.color?"color: "+t.color+";":"")+'">'+l.text+"</span>":l.text;return o}static _extend(e,l){for(var t in l){var o=l[t];isObject(o)&&e[t]?copy(e[t],o):e[t]=o}return e}static _checkParentCollapsed(e,l){var t=!1;return Object.keys(e).forEach(o=>{!0===e[o]&&!1===t&&!isNaN(l)&&+o<l&&(t=!0)}),t}static _getColSpan(e,l,t){for(var o=0,r=l.leftCol;r<=l.rightCol;r++)t&&!t(e.columns[r])||o++;return o}static _getRenderColumn(e,l){return e>=l.length?null:l[e]}static _getMergedRange(e,l,t){let o,r;for(o=0;o<t.length;o++)if(e>=(r=t[o]).topRow&&e<=r.bottomRow&&l>=r.leftCol&&l<=r.rightCol)return r;return null}};export class XlsxFormatItemEventArgs extends CellRangeEventArgs{constructor(e,l,t,o,r,s){super(e,l),this._cell=t,this._patternCell=o,this._xlsxCell=s,this._cellsCache=r}get cell(){return this._cell}get xlsxCell(){return this._xlsxCell}set xlsxCell(e){this._xlsxCell=e}getFormattedCell(){return this._cell||(this._cell=FlexGridXlsxConverter._getMeasureCell(this.panel,this.col,this._patternCell,this._cellsCache),FlexGridXlsxConverter._getCellStyle(this.panel,this._cell,this.row,this.col)),this._cell}};_registerModule("wijmo.grid.xlsx",selfModule);