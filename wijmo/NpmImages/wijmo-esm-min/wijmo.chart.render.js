/*!
    *
    * Wijmo Library 5.20192.631
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{Color,isString,Size,Point,_registerModule}from"wijmo/wijmo";import{_SvgRenderEngine,_Spline,FlexChartBase}from"wijmo/wijmo.chart";import*as selfModule from"wijmo/wijmo.chart.render";var _CanvasRenderEngine=function(){function t(t,e){void 0===e&&(e=!1),this._strokeWidth=1,this._fontSize=null,this._fontFamily=null,this._applyCanvasClip=function(t,e){var n=this._canvasRect[e];n&&(t.beginPath(),t.rect(n.left,n.top,n.width,n.height),t.clip(),t.closePath())},this._applyCanvasStyles=function(t,e,n,i,o){var s,a,l,r=this._canvas.getContext("2d"),h=this.stroke,p=this.fill,f=this.strokeWidth;e&&void 0!==e.stroke&&(h=e.stroke),e&&void 0!==e.fill&&(p=this._getOpacityColor(e.fill,e["fill-opacity"])),t&&(a=window.getComputedStyle(t),l=t.getBBox()),o?a?(r.fillStyle=a.fill,s=a.fontStyle+" "+a.fontSize+" "+a.fontFamily,r.font=s,r.font.replace(/\"/g,"'")!==s.replace(/\"/g,"'")&&(s=a.fontStyle+" "+a.fontSize+" "+(r.font.split(" ")[1]||"sans-serif"),r.font=s)):this.fontSize?(r.fillStyle=this.textFill,r.font=this.fontSize+" "+(this.fontFamily||"sans-serif")):this._canvasDefaultFont&&(r.fillStyle=this._canvasDefaultFont.textFill,s=this._canvasDefaultFont.fontSize+" "+this._canvasDefaultFont.fontFamily,r.font=s,r.font.replace(/\"/g,"'")!==s.replace(/\"/g,"'")&&(s=this._canvasDefaultFont.fontSize+" "+(r.font.split(" ")[1]||"sans-serif"),r.font=s)):(a&&(h=a.stroke&&"none"!==a.stroke?a.stroke:h,p=a.fill&&"none"!==a.fill?this._getOpacityColor(a.fill,a["fill-opacity"]):p,f=a.strokeWidth?a.strokeWidth:f),"none"!==h&&null!=h&&(this._applyColor("strokeStyle",h,l),r.lineWidth=+f.replace(/px/g,""),r.stroke()),i&&null!=p&&"transparent"!==p&&"none"!==p&&(this._applyColor("fillStyle",p,l),r.fill()))};this._element=t,this._canvas=document.createElement("canvas"),this._svgEngine=new _SvgRenderEngine(t),this._element.appendChild(this._canvas),this._applyCSSStyles=e}return t.prototype.beginRender=function(){var t,e=this._svgEngine.element,n=this._element;this._applyCSSStyles&&(this._svgEngine.beginRender(),n=e),this._element.appendChild(e),this._canvasRect={},t=window.getComputedStyle(n),this._canvasDefaultFont={fontSize:t.fontSize,fontFamily:t.fontFamily,textFill:t.color}},t.prototype.endRender=function(){this._applyCSSStyles&&this._svgEngine.endRender(),this._svgEngine.element.parentNode.removeChild(this._svgEngine.element)},t.prototype.setViewportSize=function(t,e){var n,i,o=this._canvas,s=(o.getContext("2d"),this.fill);this._applyCSSStyles&&this._svgEngine.setViewportSize(t,e),o.width=t,o.height=e,n=window.getComputedStyle(this._element).backgroundColor,i=this.stroke,n&&(this.stroke=null,this.fill=n,this.drawRect(0,0,t,e),this.fill=s,this.stroke=i)},Object.defineProperty(t.prototype,"element",{get:function(){return this._canvas},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fill",{get:function(){return this._fill},set:function(t){this._svgEngine.fill=t,this._fill=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){this._svgEngine.fontSize=t;var e=null==t||isNaN(t)?t:t+"px";this._fontSize=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fontFamily",{get:function(){return this._fontFamily},set:function(t){this._svgEngine.fontFamily=t,this._fontFamily=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stroke",{get:function(){return this._stroke},set:function(t){this._svgEngine.stroke=t,this._stroke=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"strokeWidth",{get:function(){return this._strokeWidth},set:function(t){this._svgEngine.strokeWidth=t,this._strokeWidth=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textFill",{get:function(){return this._textFill},set:function(t){this._svgEngine.textFill=t,this._textFill=t},enumerable:!0,configurable:!0}),t.prototype.addClipRect=function(t,e){t&&e&&(this._applyCSSStyles&&this._svgEngine.addClipRect(t,e),this._canvasRect[e]=t.clone())},t.prototype.drawEllipse=function(t,e,n,i,o,s){var a,l=this._canvas.getContext("2d");return this._applyCSSStyles&&(a=this._svgEngine.drawEllipse(t,e,n,i,o,s)),l.save(),l.beginPath(),l.ellipse?l.ellipse(t,e,n,i,0,0,2*Math.PI):(l.translate(t,e),l.scale(1,i/n),l.translate(-t,-e),l.arc(t,e,n,0,2*Math.PI),l.scale(1,1)),this._applyCanvasStyles(a,s,o,!0),l.restore(),a},t.prototype.drawRect=function(t,e,n,i,o,s,a){var l,r=this._canvas.getContext("2d");return this._applyCSSStyles&&(l=this._svgEngine.drawRect(t,e,n,i,o,s,a)),r.save(),this._applyCanvasClip(r,a),r.beginPath(),r.rect(t,e,n,i),this._applyCanvasStyles(l,s,o,!0),r.restore(),l},t.prototype.drawLine=function(t,e,n,i,o,s){var a,l=this._canvas.getContext("2d");return this._applyCSSStyles&&(a=this._svgEngine.drawLine(t,e,n,i,o,s)),l.save(),l.beginPath(),l.moveTo(t,e),l.lineTo(n,i),this._applyCanvasStyles(a,s,o),l.restore(),a},t.prototype.drawLines=function(t,e,n,i,o){if(t&&e&&0!==t.length&&0!==e.length){var s,a,l=this._canvas.getContext("2d"),r=Math.min(t.length,e.length);for(this._applyCSSStyles&&(s=this._svgEngine.drawLines([0,1],[1,0],n,i,o)),l.save(),this._applyCanvasClip(l,o),l.beginPath(),l.moveTo(t[0],e[0]),a=1;a<r;a++)l.lineTo(t[a],e[a]);return this._applyCanvasStyles(s,i,n),l.restore(),s}},t.prototype.drawSplines=function(t,e,n,i,o){if(t&&e&&0!==t.length&&0!==e.length){var s,a,l=this._canvas.getContext("2d"),r=new _Spline(t,e).calculate(),h=r.xs,p=r.ys,f=Math.min(h.length,p.length);for(this._applyCSSStyles&&(s=this._svgEngine.drawSplines([0,1],[1,0],n,i,o)),l.save(),this._applyCanvasClip(l,o),l.beginPath(),l.moveTo(h[0],p[0]),a=1;a<f;a++)l.lineTo(h[a],p[a]);return this._applyCanvasStyles(s,i,n),l.restore(),s}},t.prototype.drawPolygon=function(t,e,n,i,o){if(t&&e&&0!==t.length&&0!==e.length){var s,a,l=this._canvas.getContext("2d"),r=Math.min(t.length,e.length);for(this._applyCSSStyles&&(s=this._svgEngine.drawPolygon(t,e,n,i,o)),l.save(),this._applyCanvasClip(l,o),l.beginPath(),l.moveTo(t[0],e[0]),a=1;a<r;a++)l.lineTo(t[a],e[a]);return l.closePath(),this._applyCanvasStyles(s,i,n,!0),l.restore(),s}},t.prototype.drawPieSegment=function(t,e,n,i,o,s,a,l){var r,h=this._canvas.getContext("2d"),p=i,f=i+o;return this._applyCSSStyles&&(r=this._svgEngine.drawPieSegment(t,e,n,i,o,s,a,l)),h.save(),this._applyCanvasClip(h,l),h.beginPath(),h.moveTo(t,e),h.arc(t,e,n,p,f,!1),h.lineTo(t,e),this._applyCanvasStyles(r,a,s,!0),h.restore(),r},t.prototype.drawDonutSegment=function(t,e,n,i,o,s,a,l,r){var h,p,f,y=this._canvas.getContext("2d"),c=o,g=o+s;return this._applyCSSStyles&&(h=this._svgEngine.drawDonutSegment(t,e,n,i,o,s,a,l,r)),(p=new Point(t,e)).x+=i*Math.cos(c),p.y+=i*Math.sin(c),(f=new Point(t,e)).x+=i*Math.cos(g),f.y+=i*Math.sin(g),y.save(),this._applyCanvasClip(y,r),y.beginPath(),y.moveTo(p.x,p.y),y.arc(t,e,n,c,g,!1),y.lineTo(f.x,f.y),y.arc(t,e,i,g,c,!0),this._applyCanvasStyles(h,l,a,!0),y.restore(),h},t.prototype.drawString=function(t,e,n,i){var o,s=this._canvas.getContext("2d");return this._applyCSSStyles&&(o=this._svgEngine.drawString(t,e,n,i)),s.save(),s.textBaseline="bottom",this._applyCanvasStyles(o,i,n,!0,!0),s.fillText(t,e.x,e.y),s.restore(),o},t.prototype.drawStringRotated=function(t,e,n,i,o,s){var a,l=this._canvas.getContext("2d");l.measureText(t);return this._applyCSSStyles&&(a=this._svgEngine.drawStringRotated(t,e,n,i,o,s)),l.save(),l.textBaseline="bottom",l.translate(n.x,n.y),l.rotate(Math.PI/180*i),l.translate(-n.x,-n.y),this._applyCanvasStyles(a,s,o,!0,!0),l.fillText(t,e.x,e.y),l.restore(),a},t.prototype.measureString=function(t,e,n,i){var o,s=s=this._canvas.getContext("2d");return this._applyCSSStyles?this._svgEngine.measureString(t,e,n,i):(this._applyCanvasStyles(null,null,e,!0,!0),o=s.measureText(t).width,new Size(o,1.5*parseInt(s.font)))},t.prototype.startGroup=function(t,e,n){void 0===n&&(n=!1);var i,o=this._canvas.getContext("2d");return this._applyCSSStyles&&(i=this._svgEngine.startGroup(t,e,n)),o.save(),this._applyCanvasClip(o,e),i},t.prototype.endGroup=function(){this._applyCSSStyles&&this._svgEngine.endGroup(),this._canvas.getContext("2d").restore()},t.prototype.drawImage=function(t,e,n,i,o){var s,a=this._canvas.getContext("2d"),l=new Image;return this._applyCSSStyles&&(s=this._svgEngine.drawImage(t,e,n,i,o)),l.onload=function(){a.drawImage(l,e,n,i,o)},l.src=t,s},t.prototype._getOpacityColor=function(t,e){var n=new Color(t);return t.indexOf("url")>-1?this.fill:t.indexOf("-")>-1?(this.fill=t,t):(null!=e&&1===n.a&&(n.a=isNaN(e)?1:Number(e)),n.toString())},t.prototype._applyColor=function(t,e,n){var i=_GradientColorUtil.tryParse(e),o=this._canvas.getContext("2d");if(null!=i)if(isString(i)||null==n)o[t]=i;else{var s;if(null!=i.x1)s=i.relative?o.createLinearGradient(n.x+i.x1*n.width,n.y+i.y1*n.height,n.x+i.x2*n.width,n.y+i.y2*n.height):o.createLinearGradient(i.x1,i.y1,i.x2,i.y2);else if(null!=i.r)if(i.relative){var a=n.x+i.cx*n.width,l=n.y+i.cy*n.height,r=i.r*n.width,h=i.r*n.height/r,p=n.x+(null==i.fx?i.cx:i.fx)*n.width,f=n.y+(null==i.fy?i.cy:i.fy)*n.height,y=(null==i.fr?0:i.fr)*n.width,c=(null==i.fr?0:i.fr)*n.height,g=Math.min(y,c);s=o.createRadialGradient(p,f/h,g,a,l/h,r),o.setTransform(1,0,0,h,0,0)}else s=o.createRadialGradient(null==i.fx?i.cx:i.fx,null==i.fy?i.cy:i.fy,i.fr||0,i.cx,i.cy,i.r);i.colors&&i.colors.length>0&&null!=s&&i.colors.forEach(function(t){var e=new Color("#000000");null!=t.color&&(e=t.color),null!=t.opacity&&(e.a=t.opacity),s.addColorStop(t.offset,e.toString())}),o[t]=s}},t}();export{_CanvasRenderEngine};var _GradientColorUtil=function(){function t(){}return t.tryParse=function(e){if(t.parsedColor[e])return t.parsedColor[e];if(null==e||-1===e.indexOf("-"))return e;var n,i=e.replace(/\s+/g,"").split(/\-/g),o=i[0][0],s=!1,a=i[0].match(/\(\S+\)/)[0].replace(/[\(\\)]/g,"").split(/\,/g);"l"===o||"L"===o?(n={x1:"0",y1:"0",x2:"0",y2:"0",colors:[]},"l"===o&&(s=!0),["x1","y1","x2","y2"].forEach(function(t,e){null!=a[e]&&(n[t]=+a[e])})):"r"!==o&&"R"!==o||(n={cx:"0",cy:"0",r:"0",colors:[]},"r"===o&&(s=!0),["cx","cy","r","fx","fy","fr"].forEach(function(t,e){null!=a[e]&&""!==a[e]&&(n[t]=+a[e])})),n.relative=s,t.parsedColor[e]=n;var l=i.length-1;return i.forEach(function(t,e){t.indexOf(")")>-1&&(t=t.match(/\)\S+/)[0].replace(")",""));var i=t.split(":"),o={color:new Color("#000000")};null!=i[0]&&(o.color=Color.fromString(i[0])),null!=i[1]?o.offset=+i[1]:o.offset=e/l,null!=i[2]&&(o.opacity=+i[2]),n.colors.push(o)}),n},t.parsedColor={},t}();if(FlexChartBase&&FlexChartBase.prototype&&FlexChartBase.prototype._exportToImage){var _exportFn=FlexChartBase.prototype._exportToImage;FlexChartBase.prototype._exportToImage=function(t,e){if("svg"!==t){var n,i,o=new _CanvasRenderEngine(this.hostElement,!0);this._render(o,!1),(i=o.element).parentNode.removeChild(i),n=i.toDataURL("image/"+t),e.call(null,n),i=null,o=null}else _exportFn.call(this,t,e)}}_registerModule("wijmo.chart.render",selfModule);